#include <ch32v30x.h>
#include <debug.h>

#include "dhcp.h"
#include "ethernet.h"
#include "random.h"

const MACAddress kMACAddress = {.bytes = {0x38, 0x8f, 0x45, 0x16, 0x5e, 0xf6}};

void EthernetPHYLinkChangeInterrupt(bool phy_link_ready) {
  if (phy_link_ready) {
    printf("Link is UP\n");
    DHCPReset();
  } else {
    printf("Link is DOWN\n");
  }
}

const uint8_t kTestPacket[] =
    "\xff\xff\xff\xff\xff\xff\x04\x18\xd6\xc3\x2e\xbf\x08\x00"
    "\x45\x00\x01\x1c\x00\x00\x40\x00\x40\x11\x2d\xce\x0a\x00\x02\x04"
    "\xff\xff\xff\xff"
    "\xde\x49\x27\x11\x01\x08\xc8\x28"
    "\x02\x0b\x00\x5a\x02\x00\x0a\x04\x18\xd6\xc3\x2e\xbf\x0a\x00\x02"
    "\x04\x01\x00\x06\x04\x18\xd6\xc3\x2e\xbf\x13\x00\x06\x04\x18\xd6"
    "\xc3\x2e\xbf\x12\x00\x01\x48\x0a\x00\x04\x00\x15\xfb\x4d\x16\x00"
    "\x0a\x35\x2e\x30\x2e\x31\x34\x2e\x36\x36\x30\x1b\x00\x0a\x35\x2e"
    "\x30\x2e\x31\x34\x2e\x36\x36\x30\x15\x00\x03\x55\x50\x35\x1d\x00"
    "\x09\x34\x2e\x38\x2e\x33\x2e\x38\x32\x32\x17\x00\x01\x01\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00";

void EthernetReceivedInterrupt(const uint8_t* packet, uint32_t length) {
  printf("Received %lu: ", length);
  for (uint32_t i = 0; i < length; i++) {
    printf("%02x ", packet[i]);
  }
  printf("\n");
}

void ProcessDHCP() {
  switch (DHCPGetState()) {
    case DHCP_STATE_NONE:
    case DHCP_STATE_SENT_DISCOVER:
      DHCPSendDiscover(&kMACAddress);
      break;
  }
}

int main() {
  SystemCoreClockUpdate();
  Delay_Init();
  USART_Printf_Init(115200);
  RandomInitialize();

  printf("Initializing\n");
  printf("Clock: %lu\n", SystemCoreClock);

  EthernetInitialize(&kMACAddress);

  for (;;) {
    printf("Running: %d\n", EthernetTransmit(kTestPacket, sizeof(kTestPacket) - 1));
    ProcessDHCP();
    Delay_Ms(1000);
  }
}